name: workflow-ci-dev

on:
  push:
    branches:
      - dev
      - feature/**
  pull_request:

jobs:
  continuous-integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Configurar JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Criar .env para Docker Compose
        run: |
          echo "RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}" >> .env
          echo "RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_RESET_SECRET=${{ secrets.JWT_RESET_SECRET }}" >> .env
          echo "EMAIL_USUARIO=${{ secrets.EMAIL_USUARIO }}" >> .env
          echo "EMAIL_SENHA=${{ secrets.EMAIL_SENHA }}" >> .env
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env

      - name: Subir containers com Docker Compose
        run: |
          echo "Subindo MySQL + RabbitMQ..."
          docker compose up -d
          echo "Aguardando serviços inicializarem..."
          sleep 30
          docker ps -a

      - name: Executar testes unitários e integração
        env:
          SPRING_PROFILES_ACTIVE: test
          MYSQL_HOST: localhost
          MYSQL_PORT: 3308
          MYSQL_DATABASE: studiozero
          MYSQL_USER: root
          MYSQL_PASSWORD: studiozero
          RABBITMQ_USER: studiozero-admin
          RABBITMQ_PASSWORD: studiozero-rmq-pass
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
        run: mvn test -e -X

      - name: Derrubar containers
        if: always()
        run: docker compose down -v
